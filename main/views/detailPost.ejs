<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Title</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@100..900&display=swap" rel="stylesheet">
    <style>
        * {
            font-family: "Noto Sans KR", sans-serif;
        }
        #header {
            background-color : rgba(0,0,0,0.4);
            height:80px;
            width:100%;
            z-index: 1;
            position: relative;
        }
        #nav {
            height: 80px;
            display:flex;
            justify-content: center;
            align-items: center;
        }
        #nav-word {
            display:flex;
            justify-content : space-around;
            position : relative;
            width: 45%;
            right: 15px;
            align-items: center;
        }
        .word {
            font-size : 20px;
        }
        #nav a {
            color : white;
            text-decoration: none;
        }
        #nav a:hover {
            color: skyblue;
        }
        #main {
            width : 1400px;
            height : 600px;
            margin : auto;
            display : flex;
            position : relative;
            top : 30px;
        }
        #main-left {
            width : 550px;
            height : 700px;
            margin-left:10%;
            background-color: gray;
            border-right : 1px solid black;
            border-top-left-radius: 20px;
            border-bottom-left-radius: 20px;
        }
        #main-right {
            width : 650px;
            height : 700px;
            margin-right:10%;
            background-color : gray;
            border-top-right-radius: 20px;
            border-bottom-right-radius: 20px;
        }
        #tap-left {
            position : relative;
            top : 60px;
            left : 50px;
        }
        #tap-left > div {
            margin : 20px 0;
            padding : 10px;
        }
        #date {
            width : 400px;
            height: 25px;
            border : 1px solid black;
            position : relative;
            background-color : white;

        }
        #title {
            width : 400px;
            height: 25px;
            border : 1px solid black;
            background-color : white;
        }
        #author {
            width : 260px;
            height: 25px;
            border-top : 1px solid black;
            border-bottom : 1px solid black;
            border-right : none;
            border-left : 1px solid black;
            display : inline-block;
            background-color : white;
        }
        #views {
            width : 110px;
            height: 25px;
            border : 1px solid black;
            display : inline-block;
            position : relative;
            right : 3px;
            text-align : center;
            background-color : white;
        }
        #content {
            width : 400px;
            height: 300px;
            border : 1px solid black;
            background-color : white;
        }
        #tap-right {
            position : relative;
        }
        .comment-section {
            margin: 10px auto;
            border: 1px solid #000000; /* 테두리 추가 */
            padding: 10px;
            border-radius: 8px;
            background-color : white;
            position: relative;
            bottom : 80px;
            overflow-y: auto;
            width: 80%; /* 예시로 너비를 설정 */
            height: 500px;
        }

        .comment {
            margin-bottom: 5px; /* 댓글 사이에 간격 추가 */
        }

        .comment:not(:last-child) {
            border-bottom: 1px solid #ccc; /* 댓글 사이에 구분선 추가 */
            padding-bottom: 5px;
        }

        .comment:last-child {
            margin-bottom: 0;
        }

        .comment-header {
            font-size: 20px;
            font-weight: bold;
            margin-bottom: 10px;
        }

        .comment-buttons {
            margin-top: 5px;
        }

        .comment-buttons button {
            margin-right: 5px;
            background-color: #4CAF50;
            color: white;
            border: none;
            padding: 5px 10px;
            border-radius: 5px;
            cursor: pointer;
        }

        .comment-buttons button:hover {
            background-color: #45a049;
        }

        /*가운데 정렬 스타일 추가 */
        .center {
            float : left;
            text-align: center;
        }

        /* 버튼 스타일 정의 */
        .button {
            display: flex;
            background-color: #4CAF50;
            color: white;
            padding: 10px 20px;
            text-align: center;
            text-decoration: none;
            font-size: 16px;
            margin: 10px 2px;
            cursor: pointer;
            border-radius: 10px;
            position : relative;
            bottom : 550px;
            left : 180px;
        }

        /* 버튼 호버 효과 */
        .button:hover {
            background-color: #45a049;
        }

        /* 답글 달기 버튼 스타일 */
        .reply-button {
            background-color: #008CBA;
            border: none;
            color: white;
            padding: 5px 10px;
            text-align: center;
            text-decoration: none;
            display: inline-block;
            font-size: 12px;
            margin-left: 10px;
            border-radius: 5px;
        }

        /* 답글 달기 버튼 호버 효과 */
        .reply-button:hover {
            background-color: #004455;
        }

        /* 댓글 입력 폼 스타일 */
        .comment-form {
            width: 80%;
            margin: 20px auto;
        }

        .comment-input {
            width: 80%;
            padding: 10px;
            margin-bottom: 10px;
            border: 1px solid #ccc;
            border-radius: 5px;
            resize: none;
        }

        .submit-button {
            background-color: #4CAF50;
            color: white;
            padding: 20px 40px;
            text-align: center;
            text-decoration: none;
            font-size: 18px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            position : relative;
            bottom : 90px;
            left : 340px;
        }

        /* 답글 폼 스타일 */
        .reply-form {
            margin-left: 50px;
        }
    </style>
</head>
<body>
<div id="header">
    <div id="nav">
        <div id="nav-word">
            <div class="word"><a href="/main/">공지사항</a></div>
            <div class="word"><a href="/introduce/">소개&차트</a></div>
            <div class="word"><a href="#">캠핑톡</a></div>
            <div class="word"><a href="#">로그인</a></div>
        </div>
    </div>
</div>
<!--<div id="back">-->
<!--    <img src=""> -->
<!--</div>-->
<div id="main">
    <div id="main-left">
        <div id="tap-left">
            <div id="date"><%= post.created_at %></div><!--생성시간-->
            <div id="title"><%= post.title %></div><!-- 제목 -->
            <div id="author"><%= post.author %></div><!-- 작성자 -->
            <div id="views"><%= post.views %></div><!-- 조회수 -->
            <div id="content"><%= post.content %></div><!-- 내용 -->
        </div>
    </div>
    <div id="main-right">
        <div id="tap-right">
            <div class="comment-form">
                <form action="/addComment" method="POST">
                    <textarea class="comment-input" name="content" rows="5" placeholder="'<%= username%>'님 댓글을 남겨보세요" required></textarea><br>
                    <input type="hidden" name="post_id" value="<%= post.id %>">
                    <input type="hidden" name="author_id" value="<%= userId %>">
                    <input type="submit" value="등록" class="submit-button" style="left:420px; bottom:110px;">
                </form>
            </div>
            <div class="comment-section">
                <div class="comment-header">댓글</div>
                <% if (comments && comments.length > 0) { %>
                    <% comments.forEach(comment => { %>
                        <div class="comment">
                            <p><%= comment.author %>
                                <% if (comment.author_id == userId) { %>
                                    (본인)
                                <% } %>
                                &nbsp<%= comment.created_at %>
                            </p>
                            <p class="comment-content" data-comment-id="<%= comment.id %>"><%= comment.content %></p> <!-- 여기서 '.comment-content'를 추가했습니다. -->
                            <div class="comment-buttons">
                                <a href="#" class="reply-button" data-comment-id="<%= comment.id %>">답글쓰기</a>
                                <% if (comment.author_id == userId) { %> <!-- 작성자 본인의 댓글일 경우 -->
                                <button class="edit-button" data-comment-id="<%= comment.id %>">수정</button> <!-- 'data-comment-id' 속성 추가 -->
                                <form action="/deleteComment/<%= comment.id %>" method="POST" style="display: inline;">
                                    <input type="hidden" name="post_id" value="<%= post.id %>">
                                    <button type="submit">삭제</button>
                                </form>
                                <% } %>
                            </div>
                            <% if (comment.children && comment.children.length > 0) { %>
                                <% comment.children.forEach(childComment => { %>
                                    <div class="comment reply-form">
                                        <p><%= childComment.author %>
                                            <% if (childComment.author_id == userId) { %>
                                                (본인)
                                            <% } %>
                                            &nbsp<%= childComment.created_at %>
                                        </p>
                                        <!-- HTML의 속성중
                                        data- : HTML 사용자 정의 데이타 속성을 정의하는 문법.
                                        이것은 아래의 규칙이 적용된다.
                                        'data-' : prefix로 되어 나머지 텍스트를 사용하여 사용자 정의 데이터 값을 참조할수있다.
                                        data-comment-id => comment-id
                                        - 으로 연결된 단어는 카멜규칙을 적용한다. ( comment-id => commentId )
                                        이후 제이쿼리 data함수에서 comentID로 정의된 값을 참조할 수 있다.
                                        -->
                                        <p class="comment-content" data-comment-id="<%= childComment.id %>"><%= childComment.content %></p> <!-- 여기서 '.comment-content'를 추가했습니다. -->
                                        <div class="comment-buttons">
                                            <a href="#" class="reply-button" data-comment-id="<%= comment.id %>">답글쓰기</a>
                                            <% if (childComment.author_id == userId) { %> <!-- 작성자 본인의 댓글일 경우 -->
                                            <button class="edit-button" data-comment-id="<%= childComment.id %>">수정</button> <!-- 'data-comment-id' 속성 추가 -->
                                            <form action="/deleteComment/<%= childComment.id %>" method="POST" style="display: inline;">
                                                <input type="hidden" name="post_id" value="<%= post.id %>">
                                                <button type="submit">삭제</button>
                                            </form>
                                            <% } %>
                                        </div>
                                        </p>
                                    </div>
                                <% }); %>
                            <% } %>
                        </div>
                    <% }); %>
                <% } else { %>
                    <p>댓글이 없습니다.</p>
                <% } %>
            </div>
        </div>
    </div>
</div>

<div class="center">
    <a href="/boardMain" class="button">이전 페이지로 돌아가기</a>
    <a href="/editPost/<%= post.id %>" class="button">수정</a>
    <a href="/deletePost/<%= post.id %>" class="button">삭제</a>
</div>

<script src="/js/jquery.js"></script>
<script>
    $(document).ready(function() {
        // 답글쓰기 버튼 클릭 시 해당 댓글 아래에 답글 입력 폼을 표시하는 함수
        $('.reply-button').click(function(e) {
            e.preventDefault();
            const commentId = $(this).data('commentId');
            const replyForm = $(this).closest('.comment').find('.reply-form');
            if (replyForm.length === 0) {
                const newReplyForm = `
                    <div class="comment reply-form">
                        <form action="/addComment" method="POST">
                            <input type="hidden" name="post_id" value="<%= post.id %>">
                            <input type="hidden" name="author_id" value="<%= userId %>">
                            <input type="hidden" name="comment_id" value="${commentId}">
                            <textarea class="comment-input" name="content" rows="3" placeholder="'<%= username%>'님 답글을 남겨보세요" required></textarea><br>
                            <input type="submit" value="등록" class="submit-button">
                        </form>
                    </div>`;
                $(this).closest('.comment').append(newReplyForm);
            }
        });

        // '수정' 버튼 클릭 시 해당 댓글의 수정 화면을 동적으로 생성
        $(document).on('click', '.edit-button', function(e) {
            e.preventDefault();
            const commentArea = $(this).closest('.comment');
            const commentId = $(this).data('commentId');
            const existingForm = commentArea.find('.edit-form');
            if (existingForm.length === 0) {
                const commentContent = commentArea.find(`.comment-content[data-comment-id="${commentId}"]`).text().trim();
                // 수정후 상세 페이지 리다이렉시시 필요한 게시글 id를 지정
                const postId = '<%= post.id %>'; // 게시물 ID 가져오기
                const editForm = `
                    <div class="comment edit-form">
                        <form action="/editComment/${commentId}" method="POST">
                            <textarea class="comment-input" name="content" rows="3" placeholder="댓글 수정 내용을 입력하세요" required>${commentContent}</textarea><br>
                            <input type="hidden" name="post_id" value="${postId}"> <!-- 게시물 ID hidden으로 추가 -->
                            <input type="submit" value="수정 완료" class="submit-button">
                        </form>
                    </div>`;
                commentArea.append(editForm);
            }
        });
    });
</script>

</body>
</html>